

<!doctype html>
<html lang="en-US">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Backwards Planner</title>
    <!-- <link rel="stylesheet" type="text/css" href="styles.css"> -->
    <style>
      #cy {
        width: 800px;
        height: 800px;
        display: block;
      }

      .focused {
        background-color: 'red',
      }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.8.2/cytoscape.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mousetrap/1.6.3/mousetrap.min.js"></script>
    <script>
      $(document).ready(() => {
        const cy = cytoscape({
          container: document.getElementById('cy'), // container to render in
          boxSelectionEnabled: false,
          style: [
            {
              "selector": ".focused",
              "style": {
                "background-color": "red"
              }
            },
            {
              "selector": "node[label]",
              "style": {
                "label": "data(label)"
              }
            },
            {
              "selector": "edge[label]",
              "style": {
                "label": "data(label)",
                "width": 3
              }
            }
          ]
        });
        var selected = cy.add([
          { group: 'nodes', data: { id: 'root', label: 'root' }, position: { x: 100, y: 100 } },
        ]);

        const selectNode = (node) => {
          if (!node) return;
          if (!node.isNode()) return;
          selected.removeClass('focused');
          selected = node;
          selected.addClass('focused');
        }

        cy.on('select', (e) => {
          selectNode(e.target);
        });

        $('#new').submit((e) => {
          e.preventDefault();

          const ele = cy.add({
            group: 'nodes',
            data: { label: $('#goal').val() + Math.random() },
            position: { x: 50, y: 50 }
          });
          console.log(ele);
          cy.add({
            group: 'edges',
            data: {
              source: selected.id(),
              target: ele.id()
            }
          })
          cy.elements().layout({
            name: 'breadthfirst',
            roots: ['root']
          }).run();
        })

        const getFirstAbove = () => selected.incomers().nodes().eq(0);
        const getFirstBelow = () => selected.outgoers().nodes().eq(0);
        const getSiblings = () => getFirstAbove().outgoers().nodes().sort((e1, e2) => e1.position('x') - e2.position('x'));

        const getNextSibling = (i) => {
          const siblings = getSiblings();
          const siblingIds = siblings.map(s => s.id());
          const index = siblingIds.indexOf(selected.id());
          return siblings[(index + i + siblingIds.length) % siblingIds.length];
        }

        Mousetrap.bind('right', (e) => {
          selectNode(getNextSibling(1));
        })
        Mousetrap.bind('left', (e) => {
          selectNode(getNextSibling(-1));
        })

        Mousetrap.bind('up', (e) => {
          selectNode(getFirstAbove());
        })
        Mousetrap.bind('down', (e) => {
          selectNode(getFirstBelow());
        })
      })
    </script>
  </head>

  <body>
    <form id="new">
      <input type="text" id="goal" />
      <input type="submit" />
    </form>
    <div id="cy">

    </div>
  </body>
</html>